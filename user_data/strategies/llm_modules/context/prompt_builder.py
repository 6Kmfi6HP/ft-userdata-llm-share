"""
提示词构建器模块
负责构建LLM系统提示词，避免重复代码

优化历史：
- 2025-01-23: 基于Google提示词工程白皮书优化，添加强制CoT推理链，支持多策略(趋势/震荡/反转)
- 2025-01-25: 深度优化(基于白皮书高级策略):
  * 引入Step-Back Prompting(后退一步提示法) - 激活宏观背景知识
  * 强化Few-Shot示例(混合成功/失败类别) - 避免过拟合
  * 负面约束转正面指令 - 提高模型执行准确性
  * 优化角色语调(Direct, Analytical, Skeptical) - 减少废话
- 2025-01-25 (v2): 高级提示词工程技术集成:
  【开仓提示词增强】
  * 增强Step-Back: 结构化市场体制分类(6类型) + 60%置信度门控
  * 新增Tree of Thoughts (ToT): Bull/Bear/Neutral三路径并行推理 + 证据强度评分(≥60分且差距≥20分)
  * 新增Self-Reflection: 历史失败模式检查 + 相似度门控(>70%触发警告)
  【持仓提示词增强】
  * 新增Position Step-Back: 开仓体制→当前体制变化评估 + 体制变化矩阵
  * 新增Position ToT: Hold/Reduce/Exit三路径决策推理 + 资金保护优先原则
  * 新增Position Reflection: MFE回撤教训检查 + 贪婪/恐惧心理检查
- 2025-11-26: 弃用部分高级模块:
  * Tree of Thoughts (ToT): Token消耗高，LLM执行不稳定，已被Step-Back+Self-Reflection替代
  * 静态Few-Shot示例: 易过拟合，已被动态历史学习模块替代
- 2025-11-28: 代码清理 - 移除已弃用模块代码，提高可维护性
"""

import logging
from dataclasses import dataclass, field
from typing import Any, Dict, List, Optional

logger = logging.getLogger(__name__)


@dataclass
class StrategyConfig:
    """可配置的策略阈值 - 集中管理所有魔数以便调优"""

    # ADX 趋势强度阈值
    ADX_NO_TREND: int = 20          # ADX < 20: 无趋势/震荡市场
    ADX_WEAK_TREND: int = 25        # ADX 20-25: 弱趋势形成中
    # ADX > 25: 趋势确立

    # RSI 极值区阈值
    RSI_OVERSOLD: int = 30          # RSI < 30: 超卖区
    RSI_OVERSOLD_WARN: int = 35     # RSI 30-35: 超卖警告区
    RSI_OVERBOUGHT_WARN: int = 65   # RSI 65-70: 超买警告区
    RSI_OVERBOUGHT: int = 70        # RSI > 70: 超买区

    # 风险收益比阈值
    MIN_RR_RATIO: float = 2.0       # 最低风险收益比 (R:R ≥ 2:1)

    # 置信度阈值
    MIN_CONFIDENCE: int = 80        # 最低置信度
    CONFIDENCE_HALF_POSITION: int = 85   # 置信度 80-85: 50% 仓位
    CONFIDENCE_NORMAL_POSITION: int = 90  # 置信度 85-90: 70% 仓位
    # 置信度 > 90: 100% 仓位

    # 持仓时间相关 (分钟)
    MIN_HOLD_MINUTES: int = 90      # 最小持仓时间 (3根30分钟K线)
    MIN_HOLD_KLINES: int = 3        # 对应的K线数量

    # 仓位调整阈值
    ADD_POSITION_MIN_PROFIT: float = 3.0   # 加仓最低盈利 (%)
    PARTIAL_TP_THRESHOLD_1: float = 5.0    # 部分止盈阈值1 (%)
    PARTIAL_TP_THRESHOLD_2: float = 8.0    # 部分止盈阈值2 (%)
    MFE_DRAWBACK_WARNING: float = 30.0     # MFE回撤警告阈值 (%)
    MFE_DRAWBACK_CRITICAL: float = 50.0    # MFE回撤严重阈值 (%)

    # 硬止损阈值
    HARD_STOPLOSS: float = -8.0     # 硬止损百分比

    # EMA 200 接近阈值 (ATR倍数)
    EMA200_PROXIMITY_ATR: float = 1.5

    @classmethod
    def from_config(cls, config: Optional[Dict[str, Any]] = None) -> "StrategyConfig":
        """从配置字典创建实例，支持部分覆盖"""
        if not config:
            return cls()

        strategy_config = config.get("strategy_config", {})
        return cls(**{k: v for k, v in strategy_config.items() if hasattr(cls, k)})

# 导入Few-Shot格式示例
try:
    from .few_shot_examples import (
        get_format_examples_entry,
        get_format_examples_position,
    )
except ImportError:
    logger.warning("无法导入few_shot_examples，将不包含示例")

    def get_format_examples_entry() -> str:
        return ""

    def get_format_examples_position() -> str:
        return ""


class PromptBuilder:
    """LLM提示词构建器"""

    # 默认doclet配置 (精简提示词：默认禁用教程内容)
    # LLM已具备这些基础知识，无需每次重复
    # 可通过config["doclets"]按需启用
    DEFAULT_DOCLETS = {
        "kline_patterns": False,      # K线形态教程 (~50行) - 默认禁用
        "trend_structure": False,     # 趋势结构教程 (~40行) - 默认禁用
        "ema_basics": False,          # EMA基础教程 (~50行) - 默认禁用
        "macd_basics": False,         # MACD基础教程 (~45行) - 默认禁用
        "indicator_details": True,    # 指标详细说明 - 保留
    }

    def __init__(
        self,
        include_timeframe_guidance: bool = True,
        config: Optional[Dict[str, Any]] = None,
    ):
        """
        初始化提示词构建器

        Args:
            include_timeframe_guidance: 是否包含时间框架指导
            config: 配置字典，可包含:
                - "doclets": 控制可选教程内容
                - "strategy_config": 策略阈值配置 (参见 StrategyConfig)
        """
        self.include_timeframe_guidance = include_timeframe_guidance
        self.config = config or {}

        # 策略阈值配置
        self.sc = StrategyConfig.from_config(self.config)

        # Phase 4: 合并doclet配置
        self.doclets = {**self.DEFAULT_DOCLETS, **self.config.get("doclets", {})}

    def build_entry_prompt(self) -> str:
        """
        构建开仓决策专用系统提示词（模块化版本）

        优化后的 Prompt 结构流 (基于白皮书 2025-01-25 深度优化):
        1. Role & Style: 精英交易员，怀疑论语调
        2. Step-Back: 市场体制分类 + 置信度门控 (增强版)
        3. 币种风险分级: 基于历史亏损分析
        4. Historical Learning: 从历史交易中学习
        5. Chain of Thought (CoT): 完整四步推理框架
           - Step 0: 市场清晰度评估
           - Step 1: 市场结构观察
           - Step 2: 交易思路形成
           - Step 3: 信号强度与独立性评估（多指标汇聚关键！）
           - Step 4: 风险收益规划
        6. Self-Reflection: 历史教训检查
        7. Final Action: 函数调用

        Returns:
            开仓决策系统提示词
        """
        sections = [
            # 1. 角色与语调 (优化: 增加Skeptical语调)
            self._build_entry_header(),
            # 2. Step-Back Prompting (增强版: 体制分类 + 置信度门控)
            self._build_step_back_context(),
            # 2.5 日线大势判断（最高优先级，不可逆）
            self._build_daily_trend_guidance(),
            # 2.6 趋势启动与加仓策略（小仓试错，起飞加仓）
            self._build_trend_launch_and_scaling_guidance(),
            # 3. 币种风险分级 (基于历史亏损分析)
            self._build_asset_risk_classification(),
            # 4. 历史学习部分
            self._build_entry_learning_section(),
            # 5. CoT 推理框架 - 完整四步
            self._build_entry_cot_intro(),
            self._build_entry_cot_step0(),  # 步骤0: 市场清晰度评估
            self._build_indicator_selection_guide(),  # 指标组合框架 - 在步骤1之前建立
            self._build_entry_cot_step1(),  # 步骤1: 市场结构观察
            self._build_entry_cot_step2(),  # 步骤2: 交易思路形成 ✅ 恢复调用
            self._build_entry_cot_step3(),  # 步骤3: 信号强度与独立性评估 ✅ 恢复调用（关键！）
            self._build_entry_cot_step4(),  # 步骤4: 风险收益规划 ✅ 恢复调用
            "</cot_framework>",  # Close CoT framework
            # 6. 补充策略模块
            self._build_ema200_reversal_strategy(),  # EMA200均值回归策略
            self._build_entry_confirmation_rules(),  # 入场确认规则
            # 7. Self-Reflection (历史教训检查)
            self._build_self_reflection_check(),
            # 8. 杠杆风险指导
            self._build_leverage_risk_guidance(),
            # 9. 格式示例（恢复Few-Shot格式引导）
            get_format_examples_entry(),
            # 10. 最终决策
            self._build_entry_final_decision(),
        ]
        return "\n".join(filter(None, sections))

    def build_position_prompt(self) -> str:
        """
        构建持仓管理系统提示词（模块化版本）

        优化后的 Prompt 结构流 (2025-11-28 统一结构):
        1. Role & Style: 持仓管理专家（增强版 - 含语调、承诺、规则）
        2. Daily Trend Gate: 日线趋势门控（独立模块，CoT前置条件）
        3. Historical Learning: 从历史持仓管理中学习
        4. CoT 介绍
        5. Position Step-Back: 市场体制变化评估
        6. Short-Term Protection: 短期交易保护
        7. Position Reflection: MFE回撤参考
        8. CoT 评估框架: 资金保护 → 理由验证 → 前景评估
        9. Self-Reflection: 历史教训检查（与Entry对应）
        10. Format Examples: 格式示例
        11. Final Decision: 最终决策

        Returns:
            持仓管理系统提示词
        """
        sections = [
            # 1. 角色与原则（增强版 - 补充语调、承诺、规则）
            self._build_position_header(),
            # 2. 日线趋势门控（新增，独立模块，CoT前置条件）
            self._build_position_daily_trend_check(),
            # 3. 历史学习部分
            self._build_position_learning_section(),
            # 4. CoT 介绍
            self._build_position_cot_intro(),
            # 5. 市场体制变化评估
            self._build_position_step_back(),
            # 6. 短期交易保护
            self._build_short_term_protection(),
            # 7. MFE回撤参考
            self._build_position_reflection_check(),
            # 8. CoT 步骤（3步）
            self._build_position_step0(),  # 资金保护评估
            self._build_position_step1(),  # 开仓理由验证
            self._build_position_step2(),  # 前景机会评估
            "</cot_framework>",  # Close CoT framework
            # 9. 历史教训检查（新增，与Entry对应）
            self._build_position_self_reflection(),
            # 10. 格式示例
            get_format_examples_position(),
            # 11. 最终决策
            self._build_position_final_decision(),
        ]
        return "\n".join(filter(None, sections))

    # ========== 开仓提示词构建组件 ==========

    def _build_entry_header(self) -> str:
        """
        构建开仓提示词头部（角色与核心原则）

        优化: 增加语调(Style)定义
        [白皮书依据]: 定义角色的语调、风格和专业重点，可以提高输出的质量和相关性

        2025-11-27 增强: 强化怀疑论者人设，减少频繁开仓
        """
        return "\n".join(
            [
                "<role>",
                "## 角色定义",
                "你是一位**极度谨慎**的加密货币量化交易员。",
                "",
                "### 🧠 核心人设：自适应思考者",
                "**你是经验丰富的交易员，根据实际市场情况自主决策。**",
                "以下是帮助你决策的参考框架，请根据具体情况灵活运用。",
                "",
                "### 决策参考框架（优先级从高到低）",
                "",
                "**【优先级1: 趋势方向】** - 强烈建议遵守",
                "- 日线趋势方向与交易方向一致是高概率入场的基础",
                "- 4H + 1H 趋势共振可增强入场信心",
                "- 逆势交易难度更高，需要更强的理由和更小的仓位",
                "",
                "**【优先级2: 市场状态】** - 核心参考",
                f"- 4H ADX > {self.sc.ADX_NO_TREND} 表示趋势形成中，适合趋势策略",
                f"- ADX < {self.sc.ADX_NO_TREND} 时市场震荡，趋势策略效果差，考虑观望或区间策略",
                "- MACD_hist 方向与交易方向一致时，动量支持你的判断",
                "",
                "**【优先级3: 风险控制】** - 重要参考",
                f"- 日线RSI极值区（<{self.sc.RSI_OVERSOLD}或>{self.sc.RSI_OVERBOUGHT}）时均值回归概率增加，需谨慎",
                f"- 风险收益比 ≥ {self.sc.MIN_RR_RATIO}:1 是高质量交易的标志",
                f"- 置信度 ≥ {self.sc.MIN_CONFIDENCE} 才值得入场",
                "",
                "**【优先级4: 信号确认】**",
                "- 2个以上跨类别独立信号（趋势/动量/成交量）可增强置信度",
                "",
                "### ⚠️ 关键提醒",
                "- 当多个参考条件不满足时，signal_wait 通常是更安全的选择",
                "- 但如果你有充分的理由认为当前是好机会，可以自主决策",
                "- **推理过程与最终决策必须保持一致**",
                "",
                "### 系统自动拒绝的情况（硬性限制）",
                "- 该交易对在过去2小时内刚平仓",
                "- 账户当前回撤 > 10%",
                "- 连续亏损 ≥ 3笔",
                "",
                "### 仓位调整建议（基于置信度）",
                f"- 置信度 {self.sc.MIN_CONFIDENCE}-{self.sc.CONFIDENCE_HALF_POSITION}：建议使用 50% 标准仓位",
                f"- 置信度 {self.sc.CONFIDENCE_HALF_POSITION}-{self.sc.CONFIDENCE_NORMAL_POSITION}：建议使用 70% 标准仓位",
                f"- 置信度 > {self.sc.CONFIDENCE_NORMAL_POSITION}：可使用标准仓位",
                "",
                "### signal_wait 是主动选择",
                "signal_wait 不是'无能为力'，而是'主动保护资本'。",
                "在不确定的市场中，最好的交易就是不交易。",
                "等待更好的机会永远比强行入场更明智。",
                "",
                "### ⚠️ 推理与决策一致性",
                "如果你的 CoT 分析得出负面结论，但最终决策却选择开仓，",
                "这是逻辑矛盾，系统会过滤该信号。请确保推理与决策一致。",
                "",
                "### 语调风格",
                "Direct, Analytical, Skeptical (直接、分析性、怀疑论者)",
                "- 分析简练客观，避免模棱两可的词汇",
                "- 对市场信号保持健康的怀疑态度，需要多维度确认",
                "- 用数据说话，每个判断都引用具体数值",
                "",
                "### 交易周期定位",
                "- 主分析周期：30分钟K线（每30分钟重新评估）",
                f"- **最小持仓时间：{self.sc.MIN_HOLD_MINUTES}分钟（{self.sc.MIN_HOLD_KLINES}根K线）** - 开仓前请确认你准备好持有这么久",
                "- 典型持仓时长：数小时至1-2天",
                "- 多时间框架分析：日线（大势方向，不可逆）→ 4H（确定节奏）→ 1H（确认信号）→ 30M（选择时机）",
                "",
                "### 开仓承诺",
                "一旦开仓，你承诺：",
                f"- 至少持有{self.sc.MIN_HOLD_MINUTES}分钟（{self.sc.MIN_HOLD_KLINES}根完整K线），除非触发硬止损({self.sc.HARD_STOPLOSS}%)",
                "- 不会因为单根K线的波动而恐慌退出",
                "- 给交易足够的时间来验证你的判断",
                "",
                "### 交易原则",
                "- 基于上下文原始数据进行分析，引用具体数值支持你的判断",
                "- 适应不同市场状态：趋势市场、震荡市场、转折市场都有交易机会",
                "- 当市场不清晰或置信度不足时，**必须** signal_wait 来保护资本",
                "- 从大周期理解方向，在小周期寻找时机",
                "</role>",
            ]
        )

    def _build_step_back_context(self) -> str:
        """Step-Back: 市场体制识别与策略框架"""
        return "\n".join(
            [
                "<market_regime>",
                "## 市场体制识别",
                "",
                "### 📊 ADX 趋势强度评估",
                "",
                "| 4H ADX值 | 市场状态 | 策略建议 |",
                "|----------|---------|---------|",
                f"| < {self.sc.ADX_NO_TREND} | 无趋势/震荡 | ⚠️ 趋势策略胜率低，优先区间交易或观望 |",
                f"| {self.sc.ADX_NO_TREND}-{self.sc.ADX_WEAK_TREND} | 弱趋势形成中 | 💡 趋势策略可行，但建议仓位减半 |",
                f"| > {self.sc.ADX_WEAK_TREND} | 趋势确立 | ✅ 适合趋势策略，正常仓位 |",
                "",
                "**逻辑**: ADX衡量趋势强度，低ADX意味着价格在震荡，",
                "此时追涨杀跌的趋势策略会两边挨打，应等待方向明确后再入场。",
                "",
                f"> **当前 4H ADX = ___** → 是否允许趋势策略: 是(≥{self.sc.ADX_NO_TREND})/否(<{self.sc.ADX_NO_TREND})",
                "",
                "---",
                "",
                "### 体制分类参考",
                f"- A. 趋势市场: EMA清晰排列 + **ADX≥{self.sc.ADX_NO_TREND}** + 动量方向一致",
                f"- B. 震荡市场: EMA缠绕 + ADX<{self.sc.ADX_NO_TREND} + 价格在区间内波动",
                "- C. 突破酝酿: 波动率收窄 + ADX从低位回升",
                "- D. 反转初期: 结构变化 + 动量背离",
                "- E. 不清晰: 跨类别信号矛盾(如4H看空但动量+成交量看多)，难以归类",
                "",
                "> 你的体制判断及依据: _________",
                "",
                "### 不同体制下的策略思路",
                f"- 趋势确立(ADX>{self.sc.ADX_WEAK_TREND}): 顺势为主，回调是机会，RSI极值参考价值降低",
                f"- 弱趋势(ADX {self.sc.ADX_NO_TREND}-{self.sc.ADX_WEAK_TREND}): 可用趋势策略但仓位减半，谨慎操作",
                f"- 震荡市场(ADX<{self.sc.ADX_NO_TREND}): 关注支撑阻力位，均线信号参考价值降低，趋势策略胜率低",
                "- 突破酝酿: 观察为主，等待方向确认",
                "- 反转初期: 谨慎参与，多重确认",
                "- 不清晰: 观望是合理选择",
                "",
                "### 宏观背景参考",
                "- 牛/熊市背景影响RSI等指标的有效性",
                "- 不同时段波动特性不同",
                "",
                "### EMA 200 位置评估",
                "观察当前价格与各周期EMA 200的关系：",
                "- 价格在EMA 200上方：整体处于多头环境",
                "- 价格在EMA 200下方：整体处于空头环境",
                f"- 价格接近EMA 200（距离<{self.sc.EMA200_PROXIMITY_ATR}×ATR）：可能出现支撑/阻力反应",
                "",
                "> 当前价格与EMA 200的距离: ___ATR",
                "> EMA 200是否可能作为支撑/阻力: 是/否",
                "</market_regime>",
            ]
        )

    def _build_daily_trend_guidance(self) -> str:
        """
        日线趋势判断 - 不可逆的大势方向

        核心原则：日线趋势是大资金的意志，散户对抗只能当炮灰。
        """
        return "\n".join(
            [
                "<daily_trend>",
                "## 日线大势判断",
                "",
                "**日线趋势是大资金的意志，顺势操作胜率更高。**",
                "",
                "### 日线趋势定义",
                "- **多头大势**: 日线 EMA_20 > EMA_50 > EMA_100，价格在EMA_20上方",
                "- **空头大势**: 日线 EMA_20 < EMA_50 < EMA_100，价格在EMA_20下方",
                "- **震荡/不明**: 日线EMA缠绕或价格在均线之间",
                "",
                "### 趋势方向指导（强烈建议）",
                "- 日线多头大势 → 做多优先，回调是上车机会",
                "- 日线空头大势 → 做空优先，反弹是做空机会",
                "- 日线不明确 → 建议降低仓位或观望",
                "",
                "### RSI 极值区参考",
                "",
                "| 日线RSI | 做空建议 | 做多建议 | 参考原因 |",
                "|---------|----------|----------|----------|",
                f"| < {self.sc.RSI_OVERSOLD} | 不推荐 | 谨慎 | 超卖，反弹概率增加 |",
                f"| {self.sc.RSI_OVERSOLD}-{self.sc.RSI_OVERSOLD_WARN} | 仓位减半 | 可行 | 超卖警告区 |",
                f"| {self.sc.RSI_OVERSOLD_WARN}-{self.sc.RSI_OVERBOUGHT_WARN} | 可行 | 可行 | 正常区间 |",
                f"| {self.sc.RSI_OVERBOUGHT_WARN}-{self.sc.RSI_OVERBOUGHT} | 可行 | 仓位减半 | 超买警告区 |",
                f"| > {self.sc.RSI_OVERBOUGHT} | 谨慎 | 不推荐 | 超买，回调概率增加 |",
                "",
                "**思考**: RSI极值时均值回归概率增加，但强趋势中可长期极值。",
                "根据趋势强度和其他因素综合判断。",
                "",
                "### 多时间框架思考",
                "- 日线定方向，4H定节奏，1H定时机",
                "- 4H可以短期背离日线（正常回调/反弹）",
                "- 趋势交易中，多错几次小仓位试探不影响最终盈利",
                "",
                "> 当前日线趋势判断: _________（多头/空头/震荡）",
                "> 与交易方向是否一致: 是/否",
                "> 你的判断: _________",
                "</daily_trend>",
            ]
        )

    def _build_trend_launch_and_scaling_guidance(self) -> str:
        """
        趋势启动与加仓策略指导

        核心原则：找大势，选好时机，小仓试错，起飞加仓
        """
        return "\n".join(
            [
                "<trend_scaling>",
                "## 趋势启动与加仓策略",
                "",
                "**核心原则：找大势，选好时机，小仓试错，起飞加仓**",
                "",
                "### 趋势启动信号（识别加仓机会）",
                "满足以下任意 2 项即为趋势启动信号：",
                "1. ADX 从 <20 突破至 >25（趋势形成）",
                "2. 价格突破近期关键阻力/支撑位并站稳",
                "3. MACD 柱状图从负转正（做多）或从正转负（做空）且持续扩张",
                "4. 成交量放大至 MA 的 1.5 倍以上",
                "",
                "### 分批建仓策略（小仓试错）",
                "| 阶段 | 仓位占比 | 触发条件 |",
                "|------|---------|---------|",
                "| 试探入场 | 30-50% | 基本信号确认，日线+4H方向一致 |",
                "| 确认加仓 | +30% | 盈利>3% + ADX上升 + 趋势延续 |",
                "| 趋势加仓 | +20% | 盈利>6% + 趋势明确加速 |",
                "",
                "### 初始仓位建议",
                "- 趋势不明确/震荡市场: **30%** 仓位试探（保守）",
                "- 趋势较明确(ADX 20-30): **50%** 仓位入场",
                "- 趋势非常明确(ADX>30 + 多重确认): **70%** 仓位入场",
                "",
                "**剩余仓位留给趋势确认后的加仓机会**",
                "",
                "### 为什么小仓试错很重要",
                "- 主升浪没走完前，小成本试错都是值得的",
                "- 大趋势走出来，多错几次都不影响最终盈利",
                "- 趋势行情是容错率最高的行情",
                "- 你唯一要管好的就是'止损成本'",
                "",
                "> 当前趋势启动信号数量: ___个",
                "> 建议初始仓位: ___%",
                "</trend_scaling>",
            ]
        )

    def _build_asset_risk_classification(self) -> str:
        """
        币种风险分级模块 - 解决山寨币/Meme币亏损集中问题

        基于历史数据分析：
        - PIPPIN亏损$2669(6次)
        - ARC亏损$1277(4次)
        - 低流动性币种亏损严重集中
        """
        return "\n".join(
            [
                "<asset_risk>",
                "## 币种风险分级（基于历史亏损分析）",
                "",
                "历史数据显示低流动性币种亏损严重集中。在交易前识别当前币种风险等级：",
                "",
                "### 风险分级标准",
                "",
                "| 等级 | 币种 | 特点 | 策略 |",
                "|------|------|------|------|",
                "| A级(低风险) | BTC, ETH | 流动性极好，波动稳定，机构参与度高 | 正常交易，杠杆≤10x |",
                "| B级(中风险) | SOL, XRP, DOGE等前20 | 流动性较好，波动较大 | 降低仓位20%，杠杆≤8x |",
                "| C级(高风险) | 市值50名外山寨币 | 流动性差，易被操纵 | 降低仓位50%，杠杆≤5x |",
                "| D级(极高风险) | Meme币(PIPPIN等) | 极端波动，流动性极差 | 建议观望，杠杆≤3x，仓位≤5% |",
                "",
                "### 当前币种评估",
                "1. 确定市值排名和流动性水平",
                "2. 判断是否属于Meme币类别",
                "3. 选择对应风险等级",
                "4. 参考相应的杠杆和仓位限制",
                "",
                "若当前币种为C/D级且决定交易，请说明风险调整措施",
                "",
                "> 当前币种风险等级: ___级",
                "> 是否需要降低杠杆/仓位: 是/否",
                "> 调整后的杠杆上限: ___x",
                "</asset_risk>",
            ]
        )

    def _build_entry_learning_section(self) -> str:
        """构建开仓提示词学习部分"""
        return "\n".join(
            [
                "<learning>",
                "## 从历史经验中学习",
                "",
                "系统提供本交易对的历史记录：成功/失败案例、统计数据、提取模式。",
                "",
                "### 学习方向",
                "1. 识别成功模式 - 盈利交易的共同特征",
                "2. 吸取失败教训 - 亏损交易的根本原因",
                "3. 形成个性化策略 - 基于数据优化判断标准",
                "4. 持续进化 - 参考历史但不僵化套用",
                "",
                "- 当前市场与历史成功案例相似 → 可以提高置信度",
                "- 当前市场与历史失败案例相似 → 需要格外谨慎",
                "</learning>",
            ]
        )

    def _build_entry_cot_intro(self) -> str:
        """构建CoT介绍部分"""
        return "\n".join(
            [
                "<cot_framework>",
                "## 自主交易思维框架（Chain of Thought）",
                "",
                "现在运用你的交易经验分析当前市场。",
                "作为经验丰富的交易员，运用以下框架形成你的判断（灵活运用，非机械执行）：",
            ]
        )

    def _build_entry_cot_step0(self) -> str:
        """构建CoT步骤0：市场清晰度评估（非强制门槛）"""
        return "\n".join(
            [
                "",
                "<cot_step_0>",
                "— 第0步 - 市场清晰度评估（参考性评估，非强制门槛） —",
                "",
                "在深入分析前，快速观察市场是否具备可分析性：",
                "",
                "【市场可读性的思考】",
                "1. 趋势结构：4H EMA排列是清晰的还是混乱缠绕的？",
                "   → 清晰排列(ADX>25) = 趋势市场，混乱缠绕(ADX<20) = 震荡市场",
                "",
                "2. 动量方向：MACD柱状图方向与你的初步判断是否一致？",
                "   → 一致增强置信度，相反提示可能存在未观察到的转折信号",
                "",
                "3. 历史经验对照：",
                "   思考：当前市场与历史案例的相似性如何？",
                "   • 如果与成功案例相似 → 可以提高置信度",
                "   • 如果与失败案例高度相似 → 需要格外谨慎",
                "",
                "▶ 你的初步判断：",
                "  市场是否具备清晰的可分析性？还是应该选择观望？",
                "  （这是参考性评估，不是强制门槛 - 继续分析或选择观望都是合理的）",
                "",
                ">>> 你的选择：继续深入分析 / 考虑signal_wait？_________",
                "</cot_step_0>",
            ]
        )

    def _build_entry_cot_step1(self) -> str:
        """构建CoT步骤1：市场结构分析（含可选K线形态教程）"""
        # Phase 4: 基础结构部分（始终包含）
        parts = [
            "<cot_step_1>",
            "### 市场结构观察",
            "",
            "观察当前市场，形成你对结构的理解：",
            "",
        ]
        
        # Phase 4: 可选K线教程 (doclet)
        if self.doclets.get("kline_patterns", True):
            parts.append(self._build_kline_pattern_recognition())
            parts.append("")
        
        if self.doclets.get("trend_structure", True):
            parts.append(self._build_kline_trend_structure())
            parts.append("")
        
        # 结构观察提示（始终包含）
        parts.extend([
            "> 你的K线结构观察：",
            "> 识别到的形态类型：_________",
            "> 当前趋势结构（HH/HL或LH/LL）：_________",
            "> 结构支持的交易方向：_________",
            "",
            "---",
            "",
            "- 价格与关键移动平均线的关系如何？",
            "  思考：价格在均线上方还是下方？均线之间的相对位置传递什么信息？",
            "",
            "• 动量和成交量行为暗示什么？",
            "  思考：动量指标是否与价格方向一致？成交量配合情况如何？",
            "",
            "#### 历史经验对照",
            "• 查看历史交易记录，当前市场结构与哪些历史案例相似？",
            "  对比：",
            "    - 过往成功交易的市场环境是什么样的？当前是否相似？",
            "    - 过往失败交易的市场特征是什么？当前是否存在相似风险？",
            "",
            "• 基于历史统计，当前市场环境下的胜率如何？",
            "  思考：历史数据显示在类似市场结构下，过往表现如何？",
            "",
            "客观描述你观察到的市场特征和它们之间的关系，让分析自然流露。",
            "",
            "#### 多时间框架分析",
            "",
            "按顺序分析，但要综合判断：",
            "",
        ])
        
        # Phase 4: 可选EMA基础教程 (doclet)
        if self.doclets.get("ema_basics", True):
            parts.append(self._shared_ema_basics())
            parts.append("")
        
        parts.extend([
            "多时间框架应用：",
            "  • 4小时图：确定主要方向（EMA排列 + MACD柱状图）",
            "  • 1小时图：确认或识别回调（与4H一致 or 回调机会）",
            "  • 30分钟图：识别入场时机（回调反弹/突破延续/趋势跟随）",
            "",
            "三个时间框架的关系：是否共振？如果背离，你会如何理解？",
            "",
            "思考要点：",
            "  • 逆势交易（如4H空头时做多）难度较高，需要更强的确认信号",
            "  • 趋势反转确实存在，关键是识别转折的质量",
            "  • 单一时间框架信号往往不够，多维度验证更可靠",
            "",
            "#### 技术指标应用",
            "",
        ])
        
        # Phase 4: 可选MACD基础教程 (doclet)
        if self.doclets.get("macd_basics", True):
            parts.append(self._shared_macd_basics())
            parts.append("")
        
        # 指标应用指导（始终包含 - 精简版）
        parts.extend([
            "入场信号：",
            "  • 柱状图从负转正：多头动能恢复（经典回调买点）",
            "  • 柱状图扩大：趋势加速（可以追）",
            "  • 柱状图收窄：动能衰竭，可能反转",
            "",
            "EMA入场应用：",
            "  • 经典：回调到EMA20反弹（稳健）",
            "  • 激进：价格在EMA20上方奔跑时入场（强趋势）",
            "  • 突破：价格突破并站稳EMA20（趋势启动）",
            "",
            "#### 动态支撑评估",
            "  → 主动扫描 EMA20 和 EMA50，识别当前市场实际尊重哪条均线作为主要支撑",
            "  → 有时EMA50甚至EMA100也是有效支撑，根据价格行为判断",
            "",
            "RSI - 辅助确认：",
            "  • 从低位上升>40：回调可能结束",
            "  • 从高位下降<60：反弹可能结束",
            "  • 强趋势中RSI可长期极值",
            "",
            "#### RSI结合结构分析",
            "  → 当观察到RSI极值时，通过识别'价格结构破坏'(如Lower Low)来确认反转信号",
            "  → RSI超买/超卖仅作为辅助参考，以价格结构和动量为决策依据",
            "",
            "ADX - 趋势强度：",
            "  关注方向比绝对值重要：",
            "  • ADX上升 = 趋势增强",
            "  • ADX下降 = 趋势减弱",
            "  结合其他指标综合判断",
            "",
            "成交量 - 突破确认：",
            "  • 突破时放大 = 有效",
            "  • 突破时萎缩 = 假突破",
            "",
            "#### 市场状态决定指标权重",
            "",
            "根据第0步的初步判断，主动选择最相关的指标组合：",
            "",
            "如果市场呈现趋势特征 (ADX≥20, EMA排列清晰):",
            "  → 优先关注：趋势因子(EMA方向) > 动量因子(MACD扩张/收窄) > 成交量",
            "  → 将RSI权重降低：强趋势中RSI可长期极值，以趋势和动量为主要依据",
            "  → ADX>25时趋势更强，ADX 20-25时仓位可适当减半",
            "",
            "如果市场呈现震荡特征 (ADX<20, EMA缠绕):",
            "  → 优先关注：价格位置(支撑/阻力距离) > 成交量 > 动量反转信号",
            "  → 将EMA权重降低：震荡中均线方向意义不大，以价格位置为主要依据",
            "",
            "如果考虑反转交易:",
            "  → 必需三维度确认：价格结构破坏 + 动量反转(MACD/RSI同时) + 成交量配合",
            "  → 用结构确认RSI信号：RSI超卖+Higher Low形成 = 有效信号; 仅RSI超卖 = 等待",
            "",
            "这不是要求你机械套用公式，而是帮助你理解不同市场环境下的指标有效性。",
            "",
            "综合思考：基于当前市场状态，哪些跨类别信号支持你的判断？",
            "",
            "> 你的市场结构观察：_________",
            "> 历史案例对比：当前市场与历史成功/失败案例的相似度如何？_________",
        ])
        
        return "\n".join(parts + ["</cot_step_1>"])

    def _build_entry_confirmation_rules(self) -> str:
        """入场时机参考要点"""
        return "\n".join(
            [
                "<entry_timing>",
                "## 入场时机参考",
                "",
                "### 价格确认",
                "- 观察价格是否在关键位（支撑/阻力）附近企稳",
                "- 回调至均线后企稳通常是较好的入场时机",
                "- 突破后未回踩时，可考虑等待回调",
                "",
                "### RSI位置参考",
                "- RSI极值区域入场风险通常较高",
                "- 结合市场体制判断：强趋势中RSI可长期处于极值",
                "- 非趋势市场中，RSI回归中性区后入场更稳健",
                "",
                "### 信号独立性",
                "- 多个跨类别信号确认可提高置信度",
                "- 同类指标（如MACD+RSI）本质是同一信号",
                "- 趋势+动量+成交量 形成有效的多维度确认",
                "",
                "### 追高追低风险",
                "- 连续单边运动后入场风险较高",
                "- 价格远离均线时，回调概率增加",
                "- 根据市场状态灵活判断是追势还是等待",
                "</entry_timing>",
            ]
        )

    def _build_leverage_risk_guidance(self) -> str:
        """杠杆与风险参考"""
        return "\n".join(
            [
                "<leverage_risk>",
                "## 杠杆与风险参考",
                "",
                "### 杠杆选择考量因素",
                "- 币种流动性：主流币可承受较高杠杆，小市值币需谨慎",
                "- 市场波动性：高波动环境下适当降低杠杆",
                "- 信号置信度：置信度较低时降低杠杆更稳健",
                "- 交易方向：逆势交易风险更高",
                "",
                "### 风险计算参考",
                "单次交易风险 ≈ 仓位比例 × 杠杆 × 止损距离",
                "根据你的风险偏好和账户情况综合决定",
                "",
                "> 你选择的杠杆及理由: _________",
                "</leverage_risk>",
            ]
        )

    def _build_self_reflection_check(self) -> str:
        """Self-Reflection: 历史经验参考"""
        return "\n".join(
            [
                "<self_reflection>",
                "## 历史经验参考",
                "",
                "### 常见失败模式",
                "1. 追势末端: 趋势已延续较长，动量衰减时入场",
                "2. 假突破: 突破关键位但缺乏成交量确认",
                "3. 逆势交易: 在明确趋势中试图抓反转",
                "4. 信号冲突: 多空信号矛盾时强行入场",
                "",
                "### 当前决策检视",
                "思考：当前决策是否与上述失败模式存在相似性？",
                "如有相似，可考虑：",
                "- 降低仓位或调整入场时机",
                "- 等待更多确认信号",
                "- 选择观望",
                "",
                "历史是参考，不是束缚。根据当前实际情况灵活判断。",
                "</self_reflection>",
            ]
        )

    def _build_entry_cot_step2(self) -> str:
        """构建CoT步骤2：交易思路形成"""
        return "\n".join(
            [
                "",
                "<cot_step_2>",
                "— 第2步 - 交易策略的自主形成（融合历史智慧） —",
                "",
                "基于第1步的市场结构观察，形成你自己的交易策略：",
                "",
                "• 当前市场为哪个方向提供了机会？",
                "  思考：多头机会？空头机会？还是没有清晰机会？",
                "",
                "• 你的交易思路是什么？",
                "  思考：根据市场实际情况，你认为什么样的策略最合适？",
                "    这可能是顺势跟随、区间操作、结构转折，或者是观望等待",
                "    不要从固定选项中挑选，而是基于你的观察自然形成判断",
                "",
                "• 为什么这个思路与市场观察相符？",
                "  思考：用具体的价格、指标数据支持你的推理",
                "",
                "【入场时机的思考维度】",
                "作为参考，交易员通常会考虑这些入场时机的特点：",
                "",
                "趋势确立后的回调入场：",
                "  特征：等待价格回调到关键支撑，动量重新启动时进入",
                "  考虑：入场位置优、风险可控，但强趋势中可能不回调",
                "",
                "突破关键位后的追踪入场：",
                "  特征：价格突破关键位后站稳，成交量配合时跟随",
                "  考虑：不错过强劲走势，但入场成本较高，需要更大空间",
                "",
                "趋势延续中的顺势入场：",
                "  特征：趋势明确，价格沿均线运行时加入",
                "  考虑：搭上既有趋势，但需要判断趋势还有多少延续空间",
                "",
                "结构转折的逆向入场：",
                "  特征：识别趋势反转的早期信号，在新趋势起点进入",
                "  考虑：抓住新趋势起点，但难度最高，容易被假信号误导",
                "",
                "这些不是你必须选择的菜单，而是帮助你思考的参考维度。",
                "根据当前市场的实际情况，形成你自己独特的交易思路。",
                "",
                "【从历史模式中获得启发】",
                "• 查看历史成功/失败模式，有哪些经验可以应用到当前决策？",
                "  思考：",
                "    - 历史成功模式：什么样的市场环境和入场条件带来了好的结果？",
                "    - 历史失败模式：什么样的情况容易导致亏损？",
                "    - 统计数据：历史表现对当前方向的支持程度如何？",
                "",
                "• 如果当前思路与历史成功模式相似，这可以增强你的置信度",
                "• 如果当前思路与历史失败模式相似，你需要格外谨慎或重新思考",
                "• 如果是全新的市场环境，你可能需要更保守的仓位",
                "",
                "用历史数据来验证和启发你的思路，但不要被历史机械束缚。",
                "每个市场环境都是独特的，你的分析才是最重要的。",
                "",
                "▶ 你基于观察形成的交易思路：_________",
                "▶ 支持这个思路的具体市场证据：_________",
                "▶ 历史经验的启发：这个思路与历史模式的关系如何？_________",
                "</cot_step_2>",
            ]
        )

    def _build_entry_cot_step3(self) -> str:
        """构建CoT步骤3：信号强度与独立性评估（复仇者联盟框架）"""
        return "\n".join(
            [
                "",
                "<cot_step_3>",
                "— 第3步 - 信号强度与独立性评估 —",
                "",
                "### 💡 4H MACD_hist 动量一致性（重要参考）",
                "",
                "| 交易方向 | 4H MACD_hist 状态 | 建议行动 |",
                "|----------|------------------|---------|",
                "| 做空 | ≤ 0（动量向下） | ✅ 动量一致，正常仓位 |",
                "| 做空 | > 0（动量向上） | ⚠️ 逆动量，建议观望或减半仓位 |",
                "| 做多 | ≥ 0（动量向上） | ✅ 动量一致，正常仓位 |",
                "| 做多 | < 0（动量向下） | ⚠️ 逆动量，建议观望或减半仓位 |",
                "",
                "**逻辑**: MACD_hist反映4小时级别的动量方向。",
                "- MACD_hist > 0 = 4H动量向上 = 市场正在反弹/上涨",
                "- MACD_hist < 0 = 4H动量向下 = 市场正在回调/下跌",
                "逆动量入场如同逆水行舟，需要更高的确信度和更好的其他条件支撑。",
                "",
                "> **当前 4H MACD_hist = ___**",
                "> **计划交易方向 = ___**",
                "> **动量是否一致 = 是/否**",
                "",
                "💭 **如果动量不一致**: 考虑是否有足够强的其他信号支撑逆动量交易，",
                "   或者等待动量转向后再入场可能是更稳妥的选择。",
                "",
                "---",
                "",
                "【分类评估 - 避免信息冗余】",
                "",
                "1. 价格行为 (Price Action):",
                "   • 是否形成明确的Higher High/Lower Low？",
                "   • 关键支撑/阻力位的有效性？",
                "   引用数据：_________",
                "",
                "2. 确认信号 (Confirmation):",
                "   避免冗余计数（回顾【指标组合策略】）：",
                '   • EMA多头排列 = 1个趋势信号（不要再单独算"价格在EMA20上方"）',
                "   • MACD金叉 = 1个动量信号（不要再单独算RSI，两者相关）",
                "   • 成交量放大 = 1个成交量信号（独立于趋势和动量）",
                "",
                '   正确问法："我有几个跨类别的独立确认?"',
                '   错误问法："我有几个指标是正面的?"',
                "   引用数据：_________",
                "",
                "【信号独立性检查】",
                "",
                "确认你引用的信号来自不同类别：",
                "  □ 趋势因子 (EMA排列) = _____",
                "  □ 动量因子 (MACD或RSI，二选一，不重复计数) = _____",
                "  □ 成交量因子 (放大/萎缩) = _____",
                "  □ 波动率因子 (ATR/BB) = _____",
                "",
                "有多少个跨类别因子支持你的方向？_________",
                "",
                "【质量优先原则】",
                "",
                "  • 2个强有力的跨类别信号 > 3个模棱两可的同类信号",
                "  • ADX 23且上升 > ADX 26但下降（趋势变化更重要）",
                '  • 成交量放大50% + EMA突破 > 5个指标"还行"',
                "",
                "【信号冲突判断】",
                "",
                "  优先级：价格结构 > 大周期趋势(4H) > 动量 > 情绪",
                "  当高优先级信号明确时，可容忍低优先级的轻微矛盾",
                "",
                "  支持率判断（跨类别因子支持数/总数）：",
                "  • ≥3/4支持：信号强，正常开仓",
                "  • 2/4支持且无高优先级反对：信号中等，可降低仓位开仓",
                "  • <2/4或高优先级矛盾：signal_wait",
                "",
                "▶ 你的跨类别信号评估：",
                "  有多少个独立类别支持你的交易思路？这些信号的质量如何？_________",
                "",
                self._shared_noise_filter(),
                "</cot_step_3>",
            ]
        )

    def _build_entry_cot_step4(self) -> str:
        """构建CoT步骤4：风险收益规划"""
        return "\n".join(
            [
                "",
                "<cot_step_4>",
                "— 第4步 - 风险收益与仓位规划 —",
                "",
                "• 入场价位：【当前价格或计划入场点】_________",
                "",
                "• 止损位置：思考在哪里放置止损最合理？",
                "  考虑：关键支撑阻力位、市场波动性（ATR）、给予交易足够的呼吸空间",
                "  你的止损位：_________",
                "",
                "• 目标位置：合理的盈利目标在哪里？",
                "  考虑：下一个关键价位、趋势延伸空间、市场状态",
                "  你的目标位：_________",
                "",
                "• 风险收益评估：这笔交易的潜在收益是否值得承担的风险？",
                "  计算：盈利空间 vs 止损距离 = _________",
                "  判断：这个比例是否有吸引力？为什么？_________",
                "",
                "• 仓位规划：基于信号强度，你认为应该投入多少资金？",
                "  思考：信号越强、汇聚度越高 → 可以投入更多资金",
                "         信号较弱、不确定性高 → 减小仓位或等待更好时机",
                "  你的仓位决策：_________",
                "",
                "• 杠杆选择：考虑到市场波动性和信号质量，选择什么杠杆合适？",
                "  思考：高波动性需要低杠杆，信号不确定时谨慎使用杠杆",
                "  杠杆倍数：_________x",
                "",
                self._fear_greed_entry_rules(),
                "",
                "【市场情绪参考】",
                "情绪是参考，非决定性因素：",
                "  • 多空比极端(>70%单边) → 提示散户过度集中，警惕反转",
                "  • 资金费率极端 → 强趋势中可长期极端，作为参考",
                "  • 最终决策依据：价格走势 + 技术信号 > 情绪指标",
                "",
                "【资金分配的思考】",
                "",
                '理解资金池：【账户信息】中的"当前可用"是总资金池，需要预留用于：',
                "  ① 仓位调整（加仓、补仓的灵活性）",
                "  ② 其他币对的机会（系统支持多币对交易）",
                "  ③ 风险缓冲（保持应对意外的能力）",
                "",
                "基于你的置信度和信号质量，决定投入多少资金：",
                "  • 高置信度：趋势明确、多维度强确认 → 可以投入较多资金",
                "  • 中等置信度：部分信号确认、存在一些不确定性 → 适中仓位",
                "  • 低置信度：信号较弱或矛盾 → 小仓位试探或等待更好时机",
                "  • 极低置信度：市场不清晰 → signal_wait是更明智的选择",
                "",
                "综合考虑所有因素：",
                "当前市场状态 + 你的置信度 + 账户余额 + 其他仓位 + 预留空间",
                "",
                "综合你前面步骤的分析，你的最终判断是什么？风险收益比是否合理？",
                "",
                "【定义失效条件】（重要 - 用于后续持仓验证）",
                "",
                "在开仓时必须明确定义：什么情况下这笔交易的逻辑被破坏？",
                "",
                "思考并记录：",
                "• 价格失效点: 跌破/突破哪个价位意味着交易论点失败？_________",
                "• 趋势失效点: 哪个时间框架的趋势反转是致命的？_________",
                "• 时间失效点: 多长时间内没有预期进展需要重新评估？_________",
                "",
                "**请在 reason 字段中包含失效条件描述**",
                "格式: \"...失效:跌破42000或日线MACD死叉\"",
                "</cot_step_4>",
            ]
        )

    def _build_entry_final_decision(self) -> str:
        """构建开仓最终决策部分（含输出契约）"""
        return "\n".join(
            [
                "<decision>",
                "## 最终决策",
                "",
                "### 决策提醒",
                "• 综合多个维度判断，不依赖单一指标",
                "• 灵活应用你的交易经验，关注市场实际情况",
                "• 识别真实的市场转折，避免被噪声误导",
                "• **确保你的推理与决策一致（不要分析看空却做多）**",
                "",
                self._build_entry_output_contract(),
                "",
                "现在基于你的分析，做出你的交易决策。",
                "</decision>",
            ]
        )

    def _build_entry_output_contract(self) -> str:
        """构建开仓输出契约（强制格式）"""
        return "\n".join(
            [
                "<output_contract>",
                "### 输出格式要求（强制）",
                "",
                "**规则：**",
                "1. 必须且只能调用一个函数",
                "2. 不允许在函数调用之外输出任何文本",
                "3. 即使选择等待，也必须调用signal_wait函数",
                "",
                "**可用函数：**",
                "- `signal_entry_long`: 做多开仓",
                "- `signal_entry_short`: 做空开仓",
                "- `signal_wait`: 等待观望",
                "",
                "**参数Schema：**",
                "```",
                "signal_entry_long / signal_entry_short:",
                "  pair: string              # 交易对，如 \"BTC/USDT:USDT\"",
                "  leverage: int (1-20)      # 杠杆倍数",
                "  confidence_score: int (1-100)  # 置信度",
                "  reason: string            # 开仓理由（结构化要求，详见下方）",
                "  key_support: float        # 关键支撑位",
                "  key_resistance: float     # 关键阻力位",
                "  rsi_value: float          # 当前RSI数值",
                "  trend_strength: string    # 趋势强度 ('强势'|'中等'|'弱势'|'震荡'|'反转初期')",
                "",
                "  reason字段必须包含以下4个要素（用于后续持仓验证）：",
                "    1) 市场状态: 趋势/震荡/反转初期",
                "    2) 趋势对齐: D线趋势/4H趋势/1H趋势",
                "    3) 关键价位: 支撑位/阻力位",
                "    4) 失效条件: 什么情况下此交易逻辑失败",
                "  示例: \"趋势做多; D多/4H多/1H多; 支撑42000阻力44500; 失效:跌破41500或日线MACD死叉\"",
                "",
                "signal_wait:",
                "  pair: string              # 交易对",
                "  confidence_score: int (0-100)  # 置信度（0表示完全不确定）",
                "  reason: string            # 等待理由",
                "  rsi_value: float          # 当前RSI数值",
                "```",
                "</output_contract>",
                "",
                "<examples>",
                "### 输出格式示例",
                "",
                "**趋势明确 → 入场：**",
                "调用 signal_entry_long，参数：",
                '  pair="BTC/USDT:USDT", leverage=8, confidence_score=75,',
                '  reason="趋势做多; D多/4H多/1H多排列; 支撑41800阻力44000; 失效:跌破41500或4H EMA死叉",',
                "  key_support=41800.0, key_resistance=44000.0,",
                '  rsi_value=65.5, trend_strength="强势"',
                "",
                "**信号冲突 → 等待：**",
                "调用 signal_wait，参数：",
                '  pair="ETH/USDT:USDT", confidence_score=40,',
                '  reason="4H下降趋势vs30M反弹; 方向不清晰; 等待突破确认",',
                "  rsi_value=45.2",
                "",
                "**空头确认 → 做空：**",
                "调用 signal_entry_short，参数：",
                '  pair="BNB/USDT:USDT", leverage=6, confidence_score=70,',
                '  reason="趋势做空; D空/4H空/1H空排列; 支撑290阻力315; 失效:突破320或日线MACD金叉",',
                "  key_support=290.0, key_resistance=315.0,",
                '  rsi_value=35.8, trend_strength="中等"',
                "</examples>",
            ]
        )

    # ========== 持仓提示词构建组件 ==========

    def _build_position_header(self) -> str:
        """构建持仓提示词头部（角色与核心原则）- 与开仓结构一致"""
        return "\n".join(
            [
                "<role>",
                "## 持仓管理角色",
                "你是一位经验丰富的加密货币交易员，专注于30分钟K线周期的波段交易持仓管理。",
                "你需要持续评估持仓的合理性，灵活决定是持有、调整还是退出。",
                "",
                "### 持仓管理核心原则",
                "1. 💡 **日线趋势未变 → 默认继续持有**",
                "2. 💡 **4H+1H均反转 → 应评估减仓或退出**",
                "3. 💡 **关键支撑/阻力被突破 → 检查是否触发失效条件**",
                "4. 💡 **开仓理由中的失效条件触发 → 考虑退出**",
                f"5. ⏰ 最小持仓时间{self.sc.MIN_HOLD_MINUTES}分钟（除非触发硬止损{self.sc.HARD_STOPLOSS}%）",
                "6. 🔇 单根K线波动通常不是退出理由",
                "7. 📊 MFE回撤需结合趋势判断，不机械退出",
                "",
                "### 语调风格",
                "Patient, Analytical, Data-Driven (耐心、分析性、数据驱动)",
                "- 用数据说话，每个判断都引用具体数值",
                "- 区分噪音和信号：持续性变化 vs 单根K线波动",
                "",
                "### 交易周期定位",
                "- 主分析周期：30分钟K线（每30分钟重新评估持仓）",
                f"- **最小持仓时间：{self.sc.MIN_HOLD_MINUTES}分钟（{self.sc.MIN_HOLD_KLINES}根K线）** - 开仓前的承诺",
                "- 典型持仓时长：数小时至1-2天，非长期持有",
                "- 噪声过滤：30分钟周期需要过滤单根K线噪声，关注持续性变化",
                "",
                "### 持仓承诺",
                "一旦持仓，你承诺：",
                f"- 至少持有{self.sc.MIN_HOLD_MINUTES}分钟，除非触发硬止损({self.sc.HARD_STOPLOSS}%)",
                "- 不会因为单根K线的波动而恐慌退出",
                "- 给交易足够的时间来验证判断",
                "",
                "### 持仓管理原则",
                "- 保护资本是首要考虑：避免浮盈转亏损",
                "- 验证开仓理由：市场是否仍支持持仓的原始逻辑？",
                "- 评估前景机会：继续持有是否仍有吸引力？",
                "- 灵活应对市场：不同市场状态需要不同的管理方式",
                "</role>",
            ]
        )

    def _build_position_daily_trend_check(self) -> str:
        """持仓管理：多时间框架趋势检查（独立门控，最高优先级）"""
        return "\n".join(
            [
                "<trend_gate>",
                "## 多时间框架趋势门控检查（CoT 前置条件）",
                "",
                "**核心原则：开仓时的趋势对齐是持仓的基础。**",
                "",
                "### 快速检查（对照开仓时的趋势状态）",
                "",
                "| 时间框架 | 开仓时 | 当前 | 状态 |",
                "|---------|--------|------|------|",
                "| 日线 | _____ | _____ | 保持/弱化/反转 |",
                "| 4H | _____ | _____ | 保持/弱化/反转 |",
                "| 1H | _____ | _____ | 保持/弱化/反转 |",
                "",
                "### 什么是实质性转变？",
                "- **日线反转** → **立即评估退出**",
                "- **4H反转 + 1H反转** → **高度警惕，考虑减仓**",
                "- **仅1H反转** → 可能是正常回调，继续观察",
                "",
                "### 什么**不是**实质性转变？（噪音）",
                "- 单日的回调/反弹",
                "- 小时级别的EMA缠绕",
                "- RSI短暂超买/超卖",
                "",
                "### 快速决策路径",
                "- 日线未变 + 4H未变 → **倾向 signal_hold**",
                "- 日线未变 + 4H弱化 → 继续下方评估",
                "- 日线反转 → 重点评估退出条件",
                "",
                "> 趋势对齐状态: _________（全部保持/部分弱化/核心反转）",
                "</trend_gate>",
            ]
        )

    def _build_position_learning_section(self) -> str:
        """构建持仓提示词学习部分"""
        return "\n".join(
            [
                "<learning>",
                "## 从历史持仓管理中学习（优化退出策略）",
                "",
                "系统提供了历史交易的持仓管理数据，包括：",
                "- 每笔交易的MFE（最大浮盈）和MAE（最大浮亏）",
                "- 持仓时长与最终盈亏的关系",
                "- 平仓时机的评分和自我反思",
                "",
                "### 学习最佳持仓管理策略",
                "",
                "1. **分析成功退出案例**：什么时机平仓效果最好？是否过早退出错失利润？",
                "2. **吸取失败退出教训**：有多少交易曾经盈利但最终亏损？回撤的原因是什么？",
                "3. **优化持仓时长**：持仓多久的胜率最高？过早退出还是持仓过久是更常见的问题？",
                "4. **形成个性化退出规则**：根据历史MFE回撤数据，制定合理的止盈策略",
                "</learning>",
            ]
        )

    def _build_position_cot_intro(self) -> str:
        """构建持仓CoT介绍部分"""
        return "\n".join(
            [
                "<cot_framework>",
                "## 持仓评估框架（Chain of Thought）",
                "运用你的交易经验，通过以下三个维度评估持仓：",
            ]
        )

    def _build_position_step_back(self) -> str:
        """持仓管理: 市场体制变化评估"""
        return "\n".join(
            [
                "<market_regime_change>",
                "## 市场体制变化评估",
                "",
                "### 开仓时 vs 当前市场状态对比",
                "思考：",
                "- 开仓时的市场体制和核心逻辑是什么？",
                "- 当前市场体制是否发生变化？",
                "- 变化对持仓的影响是什么？",
                "",
                "### 体制变化参考",
                "- 体制未变: 开仓逻辑可能仍然有效",
                "- 趋势减弱: 动量衰减，可考虑调整",
                "- 趋势转向: 原有逻辑可能受到挑战",
                "- 不清晰: 不确定性增加，根据风险偏好判断",
                "",
                "根据实际变化情况，灵活决定持有/减仓/平仓。",
                "信号矛盾时：优先参考价格结构和开仓锚点，而非单一指标变化。",
                "</market_regime_change>",
            ]
        )

    def _build_short_term_protection(self) -> str:
        """短期持仓参考 - 强化最小持仓时间引导"""
        return "\n".join(
            [
                "<short_term_protection>",
                "## 最小持仓时间规则（重要）",
                "",
                "### 核心原则",
                "**强烈建议：持仓至少3根K线（90分钟）后再考虑退出**",
                "",
                "历史数据显示：",
                "- 持仓<30分钟的交易亏损率极高",
                "- 持仓>90分钟的交易胜率显著提升",
                "- 过早退出通常是把噪声误判为趋势反转",
                "",
                "### 允许提前退出的例外情况",
                "只有以下情况才考虑在90分钟内退出：",
                "1. **触发硬止损**：亏损达到-8%以上",
                "2. **极端市场变化**：重大利空/利好消息导致市场结构剧变",
                "3. **多重信号同时失效**：开仓依据的3个以上指标同时反转",
                "",
                "### 决策检查清单",
                "在考虑退出前，先回答：",
                "- 持仓是否已满90分钟？如果否，是否满足上述例外条件？",
                "- 当前波动是噪声还是真正的趋势反转？",
                "- 单根K线的波动不应触发退出决策",
                "</short_term_protection>",
            ]
        )

    def _build_position_reflection_check(self) -> str:
        """持仓管理: MFE回撤参考"""
        return "\n".join(
            [
                "<mfe_analysis>",
                "## MFE回撤参考",
                "",
                "### 当前持仓MFE状态",
                "思考：当前盈亏与历史最大浮盈(MFE)的关系如何？",
                "",
                "### MFE回撤的思考维度",
                "- 小幅回撤: 可能是正常波动，趋势仍在",
                "- 较大回撤: 值得警惕，考虑是否需要保护利润",
                "- 浮盈转亏: 入场逻辑或市场状态可能已变化",
                "",
                "### 心理因素参考",
                "- 贪婪: 是否因期待更多利润而忽视风险？",
                "- 恐惧: 是否因短期波动而过度恐慌？",
                "",
                "根据MFE状态和市场趋势，理性判断是继续持有还是保护利润。",
                "</mfe_analysis>",
            ]
        )

    def _build_position_step0(self) -> str:
        """构建持仓CoT步骤1：资金保护评估（最优先）"""
        return "\n".join(
            [
                "",
                "<cot_step_0>",
                "— 第1步 - 资金保护评估（最优先考虑） —",
                "",
                "作为交易员，首要考虑是保护你的资金和已获得的利润。",
                "",
                "【市场变化的有效性】",
                "首先快速评估：当前市场变化是实质性的还是短期噪声？",
                "",
                self._shared_noise_filter(),
                "",
                "如果是短期噪声（单根K线波动、未持续3根K线、变化<30% ATR）：",
                "  → 考虑signal_hold，避免被短期波动误导",
                "",
                "如果是实质性变化，继续评估资金风险：",
                "",
                "【当前盈亏状态分析】",
                "• 当前盈亏：_____% ",
                "• 最大浮盈(MFE)：_____%",
                "• 浮盈回撤：_____ (MFE - 当前盈亏)",
                "",
                "【资金保护的思考】",
                "• 如果曾经盈利但现在转为亏损：",
                "  思考：市场是否已明确转向？继续持有的风险有多大？",
                "  历史教训：很多交易从显著盈利回撤至亏损",
                "",
                "• 如果浮盈大幅回撤：",
                "  思考：是否需要锁定部分利润来保护既得成果？",
                "  市场可能正在改变，部分减仓可以降低风险",
                "",
                "• 如果持续盈利且无显著回撤：",
                "  思考：这是好迹象，但仍需评估市场是否还支持持仓",
                "",
                "【历史MFE回撤对照】",
                "• 查看历史交易：MFE达到此水平时，什么决策带来了最好的结果？",
                "• 过度持仓导致利润回吐的案例有什么共同特征？",
                "",
                "▶ 你的资金保护评估：",
                "  当前持仓的资金风险如何？是否需要采取保护措施？_________",
                "</cot_step_0>",
            ]
        )

    def _build_position_step1(self) -> str:
        """构建持仓CoT步骤2：开仓理由的有效性评估 - 增强版"""
        return "\n".join(
            [
                "",
                "<cot_step_1>",
                "— 第2步 - 开仓理由的有效性评估（强制验证） —",
                "",
                "如果资金保护评估未发现重大风险，继续评估持仓的逻辑基础。",
                "",
                "【强制验证清单】",
                "对照开仓时的条件，逐一检查当前是否仍然满足：",
                "",
                "□ 条件1 - 日线趋势一致性",
                "  开仓时日线趋势: _____ (从开仓理由中提取)",
                "  当前日线趋势: _____ (从市场数据中读取)",
                "  状态: ✓保持 / ⚠️弱化 / ✗反转",
                "",
                "□ 条件2 - 4H + 1H趋势一致性",
                "  开仓时4H趋势: _____  当前4H趋势: _____",
                "  开仓时1H趋势: _____  当前1H趋势: _____",
                "  状态: ✓保持 / ⚠️弱化 / ✗反转",
                "",
                "□ 条件3 - 关键价位完整性",
                "  开仓时关键支撑: _____ (从上下文中提取)",
                "  开仓时关键阻力: _____",
                "  当前价格: _____",
                "  支撑是否被跌破: 是/否",
                "  阻力是否被突破: 是/否",
                "",
                "□ 条件4 - 失效条件检查",
                "  开仓理由中的失效条件: _____ (从enter_tag中提取)",
                "  失效条件是否触发: 是/否",
                "",
                "【验证结果汇总】",
                "- 保持的条件数: ___/4",
                "- 弱化的条件数: ___/4",
                "- 失效的条件数: ___/4",
                "",
                "【决策指引】",
                "- 4/4保持 → 倾向 signal_hold",
                "- 1-2个弱化 → 考虑 adjust_position 减仓",
                "- 任意1个失效 → 强烈考虑 signal_exit",
                "",
                "【区分回调与反转】",
                self._distinguish_pullback_reversal(),
                "",
                "▶ 你的验证结论：",
                "  开仓条件保持/弱化/失效的数量是多少？市场变化对持仓意味着什么？_________",
                "</cot_step_1>",
            ]
        )

    def _build_position_step2(self) -> str:
        """构建持仓CoT步骤3：前景机会评估"""
        return "\n".join(
            [
                "",
                "<cot_step_2>",
                "— 第3步 - 前景机会评估（前瞻性分析） —",
                "",
                "如果资金安全且开仓理由仍有效，评估继续持有的潜力和吸引力。",
                "",
                "【趋势延续性观察】",
                "• 价格行为：",
                "  思考：价格是否继续创新高/新低？还是进入整理阶段？",
                "  当前的价格行为传递什么信息？",
                "",
                "• 动量状态：",
                "  思考：动量是增强、维持还是衰减？",
                "  ADX的方向、MACD的柱状图变化说明什么？",
                "",
                "• 趋势质量：",
                "  思考：当前趋势是清晰的还是模糊的？",
                "  多个时间框架是否仍然共振？",
                "",
                "【利润管理的思考】",
                "根据当前盈利情况和市场前景，思考最合理的行动：",
                "",
                "• 如果趋势仍然强劲且动量支持：",
                "  考虑：signal_hold 继续持有，让利润奔跑",
                "  监控：保持警惕，关注任何转弱的迹象",
                "",
                "• 如果趋势减弱但未明确反转：",
                "  考虑：adjust_position 部分减仓，锁定部分利润",
                "  平衡：保护既得利润与保留上涨空间",
                "",
                f"• 如果趋势确认且有加仓机会（趋势起飞阶段）：",
                "  **加仓是趋势交易的核心技能，不要错过'起飞'机会！**",
                "  触发条件（满足2项即可）：",
                f"  - 当前盈利 >{self.sc.ADD_POSITION_MIN_PROFIT}% + ADX 上升或维持在{self.sc.ADX_WEAK_TREND}以上",
                "  - MACD 柱状图持续扩张",
                "  - 价格未破坏趋势结构（无 Lower High / Higher Low）",
                "  加仓比例：adjust_position +30%~50%",
                "  **重要：加仓后同步调整止损至保本位**",
                "",
                "• 加仓需谨慎的条件（满足任一则建议暂缓加仓）：",
                f"  - 盈利 <{self.sc.ADD_POSITION_MIN_PROFIT}%（方向未验证，等待确认）",
                "  - ADX 下降（趋势减弱，风险增加）",
                "  - MACD 柱状图收窄（动量衰竭迹象）",
                f"  - MFE 回撤 >{self.sc.MFE_DRAWBACK_WARNING}%（市场可能反转）",
                "",
                "• 如果前景不明朗或风险增加：",
                "  考虑：signal_exit 平仓，保护资金",
                "  理由：不确定性增加时，保护资金比追求利润更重要",
                "",
                self._add_position_strategy(),
                "",
                "▶ 你的前景评估：",
                "  综合市场前景和持仓情况，最合理的行动是什么？为什么？_________",
                "</cot_step_2>",
            ]
        )

    def _build_position_self_reflection(self) -> str:
        """持仓管理：历史教训检查（与开仓的 self_reflection_check 对应）"""
        return "\n".join(
            [
                "<self_reflection>",
                "## 历史教训检查",
                "",
                "在做出决策前，回顾历史持仓管理的教训：",
                "",
                "### 常见错误模式",
                "1. **过早退出**: 因为小回调而退出，错失主升浪",
                "2. **过度持有**: 趋势已明确反转却不愿承认",
                "3. **被噪音吓跑**: 单根K线波动触发恐慌退出",
                "",
                "### 检查清单",
                "□ 我是否因为单根K线就想退出？（可能是噪音）",
                "□ 日线趋势是否真的改变了？",
                "□ 这个决定会不会让我重蹈历史覆辙？",
                "</self_reflection>",
            ]
        )

    def _build_position_final_decision(self) -> str:
        """构建持仓最终决策部分（含输出契约）"""
        return "\n".join(
            [
                "",
                "<decision>",
                "## 最终决策",
                "",
                "综合前面三个步骤的评估，做出你的持仓决策：",
                "",
                "### 决策回顾",
                "□ 资金保护：当前持仓的资金风险评估？_____",
                "□ 理由有效性：开仓理由是否仍然成立？_____",
                "□ 前景机会：继续持有的潜力如何？_____",
                "",
                self._build_position_output_contract(),
                "",
                self._position_common_errors(),
                "",
                "现在基于你的三维度评估，做出你的持仓决策。",
                "</decision>",
            ]
        )

    def _build_position_output_contract(self) -> str:
        """构建持仓管理输出契约（强制格式）"""
        return "\n".join(
            [
                "<output_contract>",
                "### 输出格式要求（强制）",
                "",
                "**规则：**",
                "1. 必须且只能调用一个函数",
                "2. 不允许在函数调用之外输出任何文本",
                "3. 即使选择持有，也必须调用signal_hold函数",
                "",
                "**可用函数：**",
                "- `signal_hold`: 继续持有当前仓位",
                "- `adjust_position`: 调整仓位大小（加仓/减仓）",
                "- `signal_exit`: 退出交易",
                "",
                "**参数Schema：**",
                "```",
                "signal_hold:",
                "  pair: string              # 交易对",
                "  confidence_score: int (1-100)  # 继续持有的置信度",
                "  reason: string            # 持有理由",
                "  rsi_value: float          # 当前RSI数值",
                "",
                "adjust_position:",
                "  pair: string              # 交易对",
                "  adjustment_pct: int       # 调整百分比（正=加仓，负=减仓）",
                "  confidence_score: int (1-100)  # 置信度",
                "  reason: string            # 调整理由",
                "  key_support: float        # 关键支撑位",
                "  key_resistance: float     # 关键阻力位",
                "",
                "signal_exit:",
                "  pair: string              # 交易对",
                "  trade_score: int (0-100)  # 交易评分",
                "  confidence_score: int (1-100)  # 平仓置信度",
                "  reason: string            # 平仓理由（详细说明）",
                "  rsi_value: float          # 当前RSI数值",
                "```",
                "</output_contract>",
                "",
                "<examples>",
                "### 输出格式示例",
                "",
                "**锚点完好 → 继续持有：**",
                "调用 signal_hold，参数：",
                '  pair="BTC/USDT:USDT", confidence_score=80,',
                '  reason="EMA多头排列保持; MACD金叉扩张; 趋势延续",',
                "  rsi_value=62.5",
                "",
                "**MFE回撤 → 部分减仓：**",
                "调用 adjust_position，参数：",
                '  pair="ETH/USDT:USDT", adjustment_pct=-30,',
                '  confidence_score=75, reason="MFE回撤33%触发保护; 锁定部分利润",',
                "  key_support=2250.0, key_resistance=2400.0",
                "",
                "**锚点破坏 → 平仓：**",
                "调用 signal_exit，参数：",
                '  pair="BNB/USDT:USDT", trade_score=40,',
                '  confidence_score=90, reason="跌破关键支撑2285; MACD死叉确认; 区间策略失效",',
                "  rsi_value=42.1",
                "</examples>",
            ]
        )

    # ========== 公共部分（可被开仓和持仓提示词复用） ==========

    # ========== K线结构分析部分 ==========

    def _build_kline_pattern_recognition(self) -> str:
        """K线形态识别指导（完整版）"""
        return """<kline_pattern_recognition>
## K线形态识别

观察K线历史数据，识别以下形态：

### 反转形态（趋势可能改变）

**双底/双顶（Double Bottom/Top）：**
- 识别：寻找两个相近的低点/高点，中间有明显反弹/回调
- 确认：第二低点≥第一低点（双底），突破颈线（中间高点）后有效
- 目标：颈线到底部的距离向上投射

**V型反转（V-Shaped Reversal）：**
- 识别：价格急剧下跌后立即急剧反弹，无明显盘整
- 特征：转折点前后K线实体大，影线短，成交量放大
- 风险：容易假突破，需成交量确认

**头肩形态（Head and Shoulders）：**
- 识别：左肩 → 更高的头部 → 右肩（高度接近左肩）
- 确认：跌破颈线（两肩低点连线）
- 目标：头部到颈线的距离

### 延续形态（趋势可能持续）

**旗形（Flag）：**
- 识别：强劲趋势后的倾斜盘整（与趋势方向相反）
- 看涨旗形：上涨后向下倾斜的小通道
- 看跌旗形：下跌后向上倾斜的小通道
- 确认：突破旗形边界，方向与原趋势一致

**三角形（Triangle）：**
- 识别：高点逐渐降低 + 低点逐渐升高，形成收敛
- 类型：对称三角形、上升三角形（底边平）、下降三角形（顶边平）
- 确认：等待突破，通常延续原趋势

**楔形（Wedge）：**
- 上升楔形（看跌）：两条向上倾斜的收敛线
- 下降楔形（看涨）：两条向下倾斜的收敛线

### 单根/多根K线形态（短期信号）

- **十字星（Doji）**：开盘≈收盘（实体<10%振幅），多空犹豫
- **锤子线（Hammer）**：小实体在顶部 + 长下影线（>2倍实体），底部反转信号
- **吞没形态（Engulfing）**：当前K线实体完全包含前一根，反转信号
- **早晨之星/黄昏之星**：三根K线组合反转信号

### 形态识别原则
1. 形态需在适当市场背景下才有效（双底应出现在下跌末期）
2. 形态越完整、越对称，可靠性越高
3. 成交量配合是形态有效性的重要确认
4. 等待形态完成和突破确认，不要预测性入场
</kline_pattern_recognition>"""

    def _build_kline_trend_structure(self) -> str:
        """趋势结构分析指导"""
        return """<trend_structure_analysis>
## 趋势结构分析

从价格摆动点（Swing Points）分析趋势状态：

### 摆动点识别
- **摆动高点（Swing High）**：某K线高点高于前后2-3根K线
- **摆动低点（Swing Low）**：某K线低点低于前后2-3根K线
- 观察K线历史标记明显的摆动高低点

### 趋势判断框架
- **上升趋势**：Higher Highs (HH) + Higher Lows (HL)
  → 每个新高高于前高，每个回调低点高于前低
- **下降趋势**：Lower Highs (LH) + Lower Lows (LL)
  → 每个反弹高点低于前高，每个新低低于前低
- **区间震荡**：无明确HH/HL或LH/LL序列
  → 高低点在水平区间内波动

### 趋势通道构建
- **支撑线**：连接2-3个摆动低点
- **阻力线**：连接2-3个摆动高点
- **通道类型**：上升通道 / 下降通道 / 水平通道

### 关键价位判断
- **有效性**：触及后反弹/受阻次数越多越有效
- **突破确认**：收盘穿越 + 幅度>30% ATR + 持续2-3根K线

### 价格位置评估
- **通道上沿**：潜在阻力/做空区域
- **通道中部**：观望区域
- **通道下沿**：潜在支撑/做多区域

### 结构质量检查
- [ ] HH/HL或LH/LL序列是否明确？
- [ ] 价格是否尊重通道边界？
- [ ] 价格在结构中的位置是否有利？
</trend_structure_analysis>"""

    # ========== 持仓管理专用部分 ==========


    def _distinguish_pullback_reversal(self) -> str:
        """区分回调与反转"""
        return """<pullback_reversal_guide>
【区分回调与反转】

趋势的结构特征：
  多头趋势 = Higher Highs + Higher Lows（每次回调低点都比上次高）
  空头趋势 = Lower Highs + Lower Lows（每次反弹高点都比上次低）

判断方法：
  结合最近的摆动高/低点、市场结构分析结果以及锚点对比信息。
  单一信号通常不足以判定反转，建议关注"价格结构 + 关键位 + 指标斜率"是否形成共振确认。
  对照当前ATR或波动率：变化幅度明显且有多根收盘价确认通常更可靠；轻微波动可能是噪声。

回调的特征：
  价格短暂回撤，但不破坏趋势结构。
  关键支撑/阻力位守住或仅被影线触碰。
  EMA排列保持原方向，或仅出现轻微噪声交错。
  ADX下滑但仍处于上升趋势 / RSI回到中性区域。
  回调结束后价格重新朝趋势方向运动。

反转的特征：
  价格结构被破坏（出现Lower High或Higher Low并确认收盘，且变化明显）。
  关键支撑/阻力位被击穿且持续站稳多根K线，或突破幅度明显。
  EMA发生实质交叉并延续，或多时间框架方向不再对齐。
  MACD在零轴附近金叉/死叉且柱状图持续扩张。
  ADX长期走弱且趋势衰竭，同时结构与价位也被破坏。
</pullback_reversal_guide>"""

    def _indicators_interpretation(self) -> str:
        """指标解读（持仓管理）"""
        return """<indicators_interpretation>
【指标解读】

单根K线的指标波动不重要，看趋势斜率与组合信号。

MACD：
  多头趋势中，MACD柱状图短暂转负属于健康回调，等待重新转正或柱状图收敛后再判断。
  只有当MACD在零轴附近死叉、动能持续减弱并伴随关键支撑失守时，才警惕反转。
  空头趋势中同理，MACD转正但缺乏结构破坏 = 正常反弹。

RSI：
  强趋势中RSI可以长期处于极值区域。
  RSI从极值回到中性区间多为回调修复，需配合结构判断。

ADX：
  关注趋势强度的变化速率，而不是单纯阈值。
  ADX较高时：趋势强劲，优先持有或考虑顺势加仓。
  ADX中等时要看斜率：上升 = 趋势刚酝酿；下降且趋势衰竭并伴随结构/价位被破 = 警惕反转。
  避免仅因为ADX下降就平仓，需要结构确认。

EMA：
  价格回踩EMA但未有效收盘跌破 = 健康回调。
  若仅出现轻微噪声交叉不要视为死叉/金叉。
  当EMA发生实质交叉并延续、且价格站稳反方向，才确认趋势反转。
</indicators_interpretation>"""

    def _add_position_strategy(self) -> str:
        """仓位调整工具"""
        return """<position_adjustment_tool>
【仓位调整工具】

adjust_position 函数用于调整现有仓位大小。

参数说明：
  pair: 交易对
  adjustment_pct: 调整百分比（正数=加仓，负数=减仓）
  confidence_score: 置信度（1-100）
  key_support: 关键支撑位
  key_resistance: 关键阻力位
  reason: 调整理由

示例：
  当前仓位100 USDT
  adjustment_pct=50 表示加仓50 USDT（总仓位变为150 USDT）
  adjustment_pct=-30 表示减仓30 USDT（总仓位变为70 USDT）

加仓的作用：
  增加仓位规模，放大潜在收益，但同时增加风险敞口。
  适用场景举例：趋势刚启动时仓位较小，确认趋势后追加仓位。

减仓的作用：
  减少仓位规模，锁定部分利润或降低风险暴露。
  适用场景举例：持仓盈利较多时分批止盈，或趋势出现不确定性时降低仓位。

注意事项：
  调整仓位会改变平均持仓成本和风险敞口。
  加仓增加风险，需要趋势明确且有信心。
  减仓可以保护利润，在盈利回撤时考虑使用。
</position_adjustment_tool>"""


    def _position_common_errors(self) -> str:
        """常见错误（持仓）"""
        return """<common_errors>
【常见错误】

需要警惕：
  被单根K线的指标变化吓跑
  正常回调时过早平仓
  持仓时间太短就急于止盈
  亏损时通过加仓摊平成本
  盈利大幅回撤时仍死守不动
  忘记开仓锚点，只看当前指标
</common_errors>"""

    def _fear_greed_entry_rules(self) -> str:
        """恐惧贪婪指数参考指南"""
        return """<fear_greed_guide>
【恐惧贪婪指数 - 参考指标】

市场情绪指标的正确使用方式：

1. 情绪指标的定位：
   • 恐惧贪婪指数是市场情绪的滞后指标，非领先信号
   • 应结合价格行为和技术结构综合判断
   • 极端情绪可能持续较长时间，不应机械应用
   • 最终决策依据：价格走势 + 技术信号 > 情绪指标

2. 极度恐惧时的参考建议（而非禁令）：
   • 恐惧指数 < 25（极度恐惧）时，建议额外关注：
     - 价格是否出现企稳信号（连续收阳、成交量配合）
     - 关键支撑位是否守住
     - EMA结构是否开始修复
   • 如价格仍在恐慌性下跌，可适当降低置信度或选择观望
   • 但若技术面出现强反转信号，不必等待情绪指数回升

3. 极度贪婪时的参考建议：
   • 贪婪指数 > 75（极度贪婪）时，建议额外关注：
     - 价格是否出现顶部形态（上影线、成交量萎缩）
     - RSI是否出现背离
     - 趋势是否仍有延续空间
   • 如技术面仍强劲，可继续持有或开仓，但适当降低杠杆

4. 多空比的参考价值：
   • 多头占比 > 70% → 提示散户追涨，可能接近阶段高点，谨慎加仓
   • 空头占比 > 70% → 提示散户恐慌，可能接近阶段低点，留意反转
   • 多空比是群体行为反映，结合价格验证更可靠

【关键原则】：
  • 情绪指标是参考工具，非决策依据
  • 价格行为 > 技术结构 > 情绪指标（优先级递减）
  • 极端情绪下提高警惕，但不应阻止有效技术信号
  • 综合分析多个维度，避免单一指标决策
</fear_greed_guide>"""

    def _noise_filtering_guidance(self) -> str:
        """信号有效性评估指导（原则性）"""
        return """<noise_filtering_guide>
【信号有效性评估指导】

在分析信号时，注意区分实质性变化和市场噪声：

关键思考点：

• 持续性考量：
  思考：这个变化是瞬时的还是延续的？单根K线的异常波动往往不可靠，
        需要观察信号是否在多根K线上保持一致。

• 幅度显著性：
  思考：相对于正常市场波动（ATR可作为参考），这次变化是显著的还是在噪声范围内？
        显著的变化更值得关注。

• 价位突破确认：
  思考：价格突破关键位后是否站稳？还是仅仅是影线试探后又回落？
        真正的突破应该有后续确认。

• 结构完整性：
  思考：价格结构（摆动高低点）的变化是否足够明显？
        轻微的波动可能只是噪声，实质性结构改变应该清晰可见。

• 信号汇聚：
  思考：多个维度（价格、均线、动量、成交量）是否都指向同一方向？
        单一信号可能误导，多重确认更可靠。

这些是思考原则而非硬性规则。根据具体市场状况灵活判断，
不要机械地数K线数量或计算百分比，而是理解背后的市场逻辑。

评估问题：
□ 信号延续性：这个信号持续了多久？是否稳定？
□ 变化显著性：相对于市场正常波动，这次变化有多显著？
□ 多重确认度：有多少个独立维度支持这个判断？
</noise_filtering_guide>"""

    # ========== 共享技术框架组件（Phase 1优化）==========

    def _shared_ema_basics(self) -> str:
        """EMA均线基础定义 - 入场和持仓共享"""
        return """<ema_basics>
## EMA均线系统
指数移动平均线，权重偏向近期价格。

**排列规则：**
- 多头排列：EMA20 > EMA50 > EMA100（趋势向上）
- 空头排列：EMA20 < EMA50 < EMA100（趋势向下）
- 震荡状态：EMA相互缠绕（无明确方向）

排列越清晰 = 趋势越强

**EMA 200 - 长期趋势线（特殊作用）：**
与短期EMA用于判断趋势排列不同，EMA 200通常作为强力动态支撑/阻力位
- 上升趋势中：EMA 200是动态支撑，价格回调到此处常有反弹
- 下降趋势中：EMA 200是动态阻力，价格反弹到此处常受压

这是一种均值回归策略，与趋势跟随策略互补使用
</ema_basics>"""

    def _build_ema200_reversal_strategy(self) -> str:
        """EMA 200 均值回归策略 - 高胜率反转入场"""
        return "\n".join(
            [
                "<ema200_strategy>",
                "## EMA 200 均值回归策略（高胜率反转入场）",
                "",
                "EMA 200是长期趋势的\"墙\"，价格撞到这道墙通常会回头。",
                "",
                "### 做多信号（支撑反弹）",
                "前提条件：",
                "1. 价格位置：从上方下跌，接近EMA 200（距离 < 1.5×ATR）",
                "2. RSI确认：RSI处于低位区域（< 40），显示卖压衰竭",
                "3. 多周期共振：1H和4H的EMA 200方向一致",
                "",
                "入场触发：价格在EMA 200附近出现止跌迹象（阳线形成）",
                "止损设置：EMA 200下方 1.5×ATR",
                "",
                "### 做空信号（阻力受压）",
                "前提条件：",
                "1. 价格位置：从下方上涨，接近EMA 200（距离 < 1.5×ATR）",
                "2. RSI确认：RSI处于高位区域（> 60），显示买盘力竭",
                "3. 多周期共振：1H和4H的EMA 200方向一致",
                "",
                "入场触发：价格在EMA 200附近出现受阻迹象（阴线形成）",
                "止损设置：EMA 200上方 1.5×ATR",
                "",
                "### 判断\"接近\"的标准",
                "使用ATR标准化距离：distance = |价格 - EMA200| / ATR",
                "- < 0.5 ATR：非常接近，高度关注",
                "- 0.5-1.5 ATR：接近范围，准备入场",
                "- > 1.5 ATR：距离较远，暂不考虑此策略",
                "",
                "### 注意事项",
                "- 此策略在震荡市场或趋势末期效果最佳",
                "- 在单边强趋势中，价格可能突破EMA 200，需设置严格止损",
                "- 多周期EMA 200方向不一致时，降低置信度",
                "</ema200_strategy>",
            ]
        )

    def _shared_macd_basics(self) -> str:
        """MACD动量指标基础定义 - 共享"""
        return """<macd_basics>
## MACD指标
动能温度计，反映动能变化速度。

**关键要素：**
- 柱状图（hist）：动能强弱（主要关注点）
- 零轴位置：多空分界线
- 方向变化：比绝对值更重要

不要机械等待MACD转正，关注趋势变化
</macd_basics>"""

    def _shared_noise_filter(self) -> str:
        """噪声过滤标准 - 统一定义，强化时间维度"""
        return """<signal_validity_reference>
## 信号有效性参考标准（退出决策必读）

### 核心规则：区分噪声与趋势反转
**单根K线的波动 = 噪声，不应触发退出决策**

### 有效信号的三个维度
1. **持续性（最重要）**：
   - 最少观察3根K线（90分钟）的持续变化
   - 单根K线的剧烈波动通常是噪声
   - 持仓未满90分钟时，对任何退出信号都应保持高度怀疑

2. **幅度**：参考30% ATR作为显著波动的判断基准
   - <30% ATR的波动：大概率是噪声
   - >50% ATR且持续2根K线以上：可能是真正的趋势变化

3. **确认**：收盘价站稳通常优于影线触碰
   - 仅影线触碰不构成退出理由
   - 需要收盘价连续2根K线确认

### 持仓时间与K线数量的对应关系
- 30分钟K线 → 持仓90分钟 = 观察了3根完整K线
- 持仓<90分钟 → 信息量不足以做出可靠的退出判断
- 除非触发硬止损，否则应等待更多K线确认

若判断信号有效但未完全满足上述标准，请在分析中说明理由（如跨类别信号强共振、市场体制特殊性等）
</signal_validity_reference>"""

    def _build_indicator_selection_guide(self) -> str:
        """指标组合思路"""
        return """<indicator_guide>
## 指标组合思路

### 跨类别信号更有价值
指标类别：
- 趋势因子: EMA排列
- 动量因子: RSI, MACD（同类，选一即可）
- 成交量因子: 放量/缩量
- 波动率因子: ATR
- 情绪因子: 资金费率, 多空比

同类指标本质是同一信号，跨类别信号才能提供独立确认。

### 市场状态影响指标有效性
- 趋势市场: 趋势因子权重高，RSI极值参考价值降低
- 震荡市场: 支撑阻力位更重要，均线信号参考价值降低
- 反转交易: 需要多维度确认

### 信号质量参考
历史统计仅供参考：
- 回调入场、情绪逆向 - 历史表现相对较好
- MACD单独使用 - 历史表现一般，更适合作为辅助确认

最终决策基于综合分析，灵活运用。
</indicator_guide>"""

